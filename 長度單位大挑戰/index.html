<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·åº¦å–®ä½å¤§æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
        }
        .bounce {
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }
        .correct-pop {
            animation: pop 0.4s ease-out;
        }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        /* ç¦ç”¨ç‹€æ…‹çš„æ¨£å¼ */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="game-container" class="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl p-8 border-4 border-blue-400 relative overflow-hidden">
        
        <!-- è£é£¾è£é£¾ -->
        <div class="absolute -top-4 -right-4 opacity-10 text-8xl pointer-events-none">ğŸ“</div>
        
        <!-- é¸æ“‡å¹´ç´šç•«é¢ -->
        <div id="start-screen" class="text-center">
            <div class="mb-6 inline-block bg-blue-100 p-4 rounded-full">
                <span class="text-5xl">ğŸ’</span>
            </div>
            <h1 class="text-3xl font-bold text-blue-600 mb-2">é•·åº¦å–®ä½å¤§æŒ‘æˆ°</h1>
            <p class="text-gray-500 mb-8">é¸æ“‡å¹´ç´šï¼Œæ¸¬è©¦ä½ çš„ç©ºé–“æ„Ÿï¼<br>(å…± 25 é¡Œ)</p>
            
            <div class="space-y-4">
                <button onclick="startGame(3)" class="w-full bg-orange-400 hover:bg-orange-500 text-white font-bold py-5 rounded-2xl shadow-lg transform transition active:scale-95 text-xl">
                    ä¸‰å¹´ç´šæŒ‘æˆ° <br>
                    <span class="text-xs font-normal opacity-90">(æ¯«ç±³ã€å…¬åˆ†ã€å…¬å°º)</span>
                </button>
                <button onclick="startGame(4)" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-5 rounded-2xl shadow-lg transform transition active:scale-95 text-xl">
                    å››ã€äº”å¹´ç´šæŒ‘æˆ° <br>
                    <span class="text-xs font-normal opacity-90">(åŒ…å«ã€Œå…¬é‡Œã€é€²éšé¡Œ)</span>
                </button>
            </div>
        </div>

        <!-- éŠæˆ²é€²è¡Œç•«é¢ -->
        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <div class="flex flex-col">
                    <span id="grade-badge" class="text-xs font-bold text-blue-500 mb-1 uppercase tracking-wider">æ¨¡å¼è¼‰å…¥ä¸­</span>
                    <div class="bg-blue-100 px-4 py-1 rounded-full text-blue-700 font-bold text-sm">
                        ç¬¬ <span id="current-index">1</span> / 25 é¡Œ
                    </div>
                </div>
                <div class="bg-green-100 px-4 py-2 rounded-full text-green-700 font-bold shadow-sm">
                    å¾—åˆ†: <span id="score">0</span>
                </div>
            </div>

            <div id="question-box" class="bg-yellow-50 rounded-3xl p-6 mb-4 border-2 border-yellow-200 text-center min-h-[160px] flex flex-col justify-center shadow-inner">
                <h2 id="question-text" class="text-lg font-medium text-gray-600 mb-2"></h2>
                <div class="flex items-baseline justify-center gap-2">
                    <span id="question-hint" class="text-5xl font-black text-blue-600"></span>
                    <span class="text-gray-400 text-xl font-bold">?</span>
                </div>
            </div>

            <!-- AI è¼”åŠ©æŒ‰éˆ• -->
            <button id="ai-hint-btn" onclick="askAiAssistant()" class="w-full mb-6 bg-purple-50 hover:bg-purple-100 text-purple-600 text-sm font-bold py-3 rounded-xl border border-purple-200 transition duration-200 flex items-center justify-center gap-2 group">
                <span class="group-hover:rotate-12 transition-transform">âœ¨</span>
                <span>è€å¸«ï¼Œçµ¦æˆ‘ä¸€é»æç¤ºï¼</span>
            </button>

            <div id="options-grid" class="grid grid-cols-2 gap-4">
                <!-- ç”± JS ç”Ÿæˆ -->
            </div>

            <div id="feedback" class="mt-6 text-center h-8 font-bold text-lg transition-all duration-300"></div>
        </div>

        <!-- çµç®—ç•«é¢ -->
        <div id="result-screen" class="hidden text-center">
            <div class="text-7xl mb-4 bounce">ğŸ†</div>
            <h2 class="text-3xl font-bold text-blue-600 mb-2">å¤ªæ£’äº†ï¼æŒ‘æˆ°å®Œæˆ</h2>
            
            <div class="bg-blue-50 rounded-3xl p-6 mb-6 border-2 border-blue-100">
                <p class="text-gray-500 font-bold mb-1">æœ€çµ‚åˆ†æ•¸</p>
                <p class="text-6xl font-black text-blue-600"><span id="final-score">0</span></p>
            </div>
            
            <!-- AI ç¸½çµ -->
            <div id="ai-summary" class="bg-purple-50 rounded-2xl p-5 mb-8 border border-purple-200 text-left hidden">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xl">ğŸ‘©â€ğŸ«</span>
                    <span class="font-bold text-purple-700">AI è€å¸«çš„çµèªï¼š</span>
                </div>
                <div id="ai-summary-text" class="text-sm text-purple-800 leading-relaxed italic">
                    æ­£åœ¨æ’°å¯«å°ˆå±¬è©•èª...
                </div>
            </div>

            <button onclick="showStartScreen()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg transition active:scale-95">
                å†ç©ä¸€æ¬¡
            </button>
        </div>
    </div>

    <!-- AI æç¤ºå½ˆçª— -->
    <div id="ai-modal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-6 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] p-8 max-w-sm w-full shadow-2xl transform transition-all scale-100">
            <div class="flex items-center gap-3 mb-4 text-purple-600">
                <div class="bg-purple-100 p-2 rounded-lg text-2xl">âœ¨</div>
                <h3 class="font-bold text-xl">è§€å¿µå°å¼•å°</h3>
            </div>
            <div id="ai-modal-content" class="text-gray-600 leading-relaxed mb-8 text-lg">
                æ€è€ƒä¸­...
            </div>
            <!-- å¢åŠ äº† id="close-ai-modal-btn" ä¸¦é è¨­ç‚º disabled -->
            <button id="close-ai-modal-btn" onclick="closeAiModal()" disabled class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-2xl shadow-lg transition active:scale-95 disabled:bg-gray-300 disabled:shadow-none">
                æˆ‘æ‡‚äº†ï¼Œå»ç­”é¡Œï¼
            </button>
        </div>
    </div>

    <script>
        const apiKey = ""; // Runtime provides the key
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'unit-quiz-gemini';

        const allQuestions = {
            3: [
                { item: "ä¸€æšç¡¬å¹£çš„åšåº¦", value: 2, unit: "æ¯«ç±³" },
                { item: "å½©è‰²ç­†çš„é•·åº¦", value: 15, unit: "å…¬åˆ†" },
                { item: "æ•™å®¤çš„é«˜åº¦", value: 3, unit: "å…¬å°º" },
                { item: "æ©¡çš®æ“¦çš„é•·åº¦", value: 5, unit: "å…¬åˆ†" },
                { item: "ä¸€éš»èèŸ»çš„èº«é•·", value: 6, unit: "æ¯«ç±³" },
                { item: "é»‘æ¿çš„æ©«å¯¬", value: 4, unit: "å…¬å°º" },
                { item: "æ ¡é–€å£åˆ°æ•™å®¤è·é›¢", value: 50, unit: "å…¬å°º" },
                { item: "é‰›ç­†ç›’çš„åšåº¦", value: 3, unit: "å…¬åˆ†" },
                { item: "å°èºçµ²é‡˜çš„é•·åº¦", value: 8, unit: "æ¯«ç±³" },
                { item: "æ¸¸æ³³æ± çš„é•·åº¦", value: 25, unit: "å…¬å°º" },
                { item: "æ‰‹æ©Ÿçš„å¯¬åº¦", value: 7, unit: "å…¬åˆ†" },
                { item: "è¡›ç”Ÿç´™ç›’çš„é«˜åº¦", value: 9, unit: "å…¬åˆ†" },
                { item: "å¤§è¿´ç´‹é‡çš„é•·åº¦", value: 30, unit: "æ¯«ç±³" },
                { item: "ä½ çš„èº«é«˜å¤§ç´„æ˜¯ 140", value: 140, unit: "å…¬åˆ†" },
                { item: "å…¬è»Šçš„è»Šèº«é•·åº¦", value: 12, unit: "å…¬å°º" },
                { item: "ä¸€å…ƒç¡¬å¹£çš„ç›´å¾‘", value: 20, unit: "æ¯«ç±³" },
                { item: "è† æ°´ç“¶çš„é«˜åº¦", value: 12, unit: "å…¬åˆ†" },
                { item: "ä¸€éš»å°è²“çš„èº«é•·", value: 30, unit: "å…¬åˆ†" },
                { item: "æ›¸æ¡Œçš„å¯¬åº¦", value: 60, unit: "å…¬åˆ†" },
                { item: "è·¯é‚Šé›»ç·šæ¡¿çš„é«˜åº¦", value: 10, unit: "å…¬å°º" },
                { item: "è¨‚æ›¸é‡çš„å¯¬åº¦", value: 12, unit: "æ¯«ç±³" },
                { item: "è‡ªå‹•ç­†èŠ¯çš„ç²—ç´°", value: 0.5, unit: "æ¯«ç±³" },
                { item: "æ¨™æº–ç±ƒçƒå ´çš„é•·åº¦", value: 28, unit: "å…¬å°º" },
                { item: "ä¸€èˆ¬é•·å°ºçš„é•·åº¦", value: 30, unit: "å…¬åˆ†" },
                { item: "ä¸€æ£µå¤§æ¨¹çš„é«˜åº¦", value: 15, unit: "å…¬å°º" }
            ],
            4: [
                { item: "åœ‹é“ä¸€è™Ÿå…¬è·¯å…¨é•·", value: 374, unit: "å…¬é‡Œ" },
                { item: "å°åŒ— 101 å¤§æ¨“é«˜åº¦", value: 508, unit: "å…¬å°º" },
                { item: "æ™ºæ…§å‹æ‰‹æ©Ÿçš„åšåº¦", value: 9, unit: "æ¯«ç±³" },
                { item: "å…¨ç¨‹é¦¬æ‹‰æ¾æ¯”è³½è·é›¢", value: 42, unit: "å…¬é‡Œ" },
                { item: "èª²æ¡Œæ¤…çš„é«˜åº¦", value: 75, unit: "å…¬åˆ†" },
                { item: "å°ç£æœ€é«˜å³°ç‰å±±é«˜åº¦", value: 3952, unit: "å…¬å°º" },
                { item: "å°åŒ—åˆ°é«˜é›„çš„ç›´ç·šè·é›¢", value: 350, unit: "å…¬é‡Œ" },
                { item: "ä¸€æœ¬æ•¸å­¸èª²æœ¬çš„åšåº¦", value: 1, unit: "å…¬åˆ†" },
                { item: "æ¨™æº–ç”°å¾‘å ´è·‘é“ä¸€åœˆ", value: 400, unit: "å…¬å°º" },
                { item: "æ·é‹è»Œé“çš„å¯¬åº¦", value: 1435, unit: "æ¯«ç±³" },
                { item: "å°ç£æœ¬å³¶å—åŒ—çš„é•·åº¦", value: 394, unit: "å…¬é‡Œ" },
                { item: "è‡ªè¡Œè»Šå°ˆç”¨é“çš„ç¸½é•·", value: 15, unit: "å…¬é‡Œ" },
                { item: "å­¸æ ¡æ——æ¡¿çš„é«˜åº¦", value: 12, unit: "å…¬å°º" },
                { item: "ä¸€æ ¹ç«æ¯›çš„é•·åº¦", value: 8, unit: "æ¯«ç±³" },
                { item: "ç¤¾å€ç™»å±±æ­¥é“çš„å…¨é•·", value: 3500, unit: "å…¬å°º" },
                { item: "è˜‡èŠ±å…¬è·¯ç¸½é•·åº¦", value: 118, unit: "å…¬é‡Œ" },
                { item: "æŒ‡ç”²ç”Ÿé•·ä¸€å€‹æœˆç´„", value: 3, unit: "æ¯«ç±³" },
                { item: "ä¸€å¼µæ‚ éŠå¡çš„åšåº¦", value: 1, unit: "æ¯«ç±³" },
                { item: "å¤§å‹è²¨æ«ƒè»Šçš„é•·åº¦", value: 12, unit: "å…¬å°º" },
                { item: "åœ°çƒèµ¤é“çš„å‘¨é•·", value: 40075, unit: "å…¬é‡Œ" },
                { item: "æ²³é‚Šæ•£æ­¥æ­¥é“çš„å¯¬åº¦", value: 4, unit: "å…¬å°º" },
                { item: "å…­äººåº§é¤æ¡Œçš„é•·åº¦", value: 180, unit: "å…¬åˆ†" },
                { item: "ç­†è¨˜å‹é›»è…¦è¢å¹•å¯¬åº¦", value: 35, unit: "å…¬åˆ†" },
                { item: "äººé¡ä¸€æ ¹é ­é«®çš„ç›´å¾‘", value: 0.1, unit: "æ¯«ç±³" },
                { item: "ç«è»Šè»Šå»‚çš„é•·åº¦", value: 20, unit: "å…¬å°º" }
            ]
        };

        const unitsByGrade = {
            3: ["æ¯«ç±³", "å…¬åˆ†", "å…¬å°º"],
            4: ["æ¯«ç±³", "å…¬åˆ†", "å…¬å°º", "å…¬é‡Œ"]
        };

        let currentGrade = 3;
        let currentQuestions = [];
        let currentIndex = 0;
        let score = 0;

        async function geminiFetch(prompt, systemInstruction = "") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
            return "æŠ±æ­‰ï¼Œè€å¸«å‰›æ‰ç™¼å‘†äº†ï¼Œè«‹å†é»ä¸€æ¬¡ï¼";
        }

        async function askAiAssistant() {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-modal-content');
            const closeBtn = document.getElementById('close-ai-modal-btn');
            const currentQ = currentQuestions[currentIndex];
            
            // é–‹å•Ÿè¦–çª—ä¸¦ç¦ç”¨æŒ‰éˆ•
            modal.style.display = 'flex';
            content.innerText = "æ­£åœ¨ç‚ºä½ å°‹æ‰¾ç”Ÿæ´»ä¸­çš„æ¯”å–»...";
            closeBtn.disabled = true;

            const prompt = `é¡Œç›®æ˜¯ã€Œ${currentQ.item}ã€ï¼Œæ•¸å€¼æ˜¯ã€Œ${currentQ.value}ã€ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯ã€Œ${currentQ.unit}ã€ã€‚
            è«‹ä»¥è¦ªåˆ‡å°å­¸è€å¸«çš„å£å»ï¼Œç”¨å…©å¥è©±çµ¦å­¸ç”Ÿæç¤ºã€‚ä¸è¦ç›´æ¥èªªå‡ºç­”æ¡ˆã€‚æç¤ºæ–¹å‘å¯ä»¥æ˜¯ï¼šæŠŠé€™å€‹é•·åº¦è·Ÿèº«é«”éƒ¨ä½ï¼ˆå¦‚æ‰‹æŒ‡ã€æ­¥é•·ï¼‰æˆ–å¸¸è¦‹ç‰©å“æ¯”è¼ƒã€‚`;
            
            const systemMsg = "ä½ æ˜¯ä¸€ä½å¹½é»˜ä¸”æº«æš–çš„å°å­¸æ•¸å­¸è€å¸«ï¼Œæ“…é•·å°‡é•·åº¦å–®ä½å…·è±¡åŒ–ã€‚";
            const result = await geminiFetch(prompt, systemMsg);
            
            // å…§å®¹å¡«å…¥å¾Œå•Ÿç”¨æŒ‰éˆ•
            content.innerText = result;
            closeBtn.disabled = false;
        }

        function closeAiModal() {
            document.getElementById('ai-modal').style.display = 'none';
        }

        async function getAiFinalSummary() {
            const container = document.getElementById('ai-summary');
            const text = document.getElementById('ai-summary-text');
            container.classList.remove('hidden');
            
            const prompt = `å­¸ç”Ÿå®Œæˆäº† 25 é¡ŒæŒ‘æˆ°ã€‚å¹´ç´šï¼š${currentGrade === 3 ? 'ä¸‰å¹´ç´š' : 'å››äº”å¹´ç´š'}ï¼Œå¾—åˆ†ï¼š${score}/100ã€‚
            è«‹å¯«ä¸€å¥ç°¡çŸ­çš„è©•èªã€‚å¦‚æœåˆ†æ•¸é«˜ï¼Œçµ¦äºˆèª‡çï¼›å¦‚æœåˆ†æ•¸ä½ï¼Œçµ¦äºˆæº«æš–çš„é¼“å‹µä¸¦æé†’è©²æ³¨æ„å“ªç¨®å–®ä½çš„å€åˆ†ã€‚50å­—ä»¥å…§ã€‚`;
            
            const result = await geminiFetch(prompt, "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ•™è‚²å°å¸«ã€‚");
            text.innerText = result;
        }

        function showStartScreen() {
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
        }

        function startGame(grade) {
            currentGrade = grade;
            currentQuestions = [...allQuestions[grade]].sort(() => Math.random() - 0.5).slice(0, 25);
            currentIndex = 0;
            score = 0;
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            
            document.getElementById('grade-badge').innerText = grade === 3 ? "åŸºç¤æ¨¡å¼ (3å¹´ç´š)" : "é€²éšæ¨¡å¼ (4-5å¹´ç´š)";
            updateScore();
            showQuestion();
        }

        function showQuestion() {
            const feedback = document.getElementById('feedback');
            feedback.innerText = "";
            const q = currentQuestions[currentIndex];
            
            document.getElementById('current-index').innerText = currentIndex + 1;
            document.getElementById('question-text').innerText = q.item;
            document.getElementById('question-hint').innerText = q.value;

            const grid = document.getElementById('options-grid');
            grid.innerHTML = "";
            
            const currentUnits = unitsByGrade[currentGrade];
            currentUnits.forEach(unit => {
                const btn = document.createElement('button');
                btn.className = "bg-white hover:bg-blue-50 border-2 border-blue-200 rounded-2xl py-5 font-bold text-gray-700 transition duration-200 shadow-sm active:bg-blue-100 transform active:scale-95";
                btn.innerText = unit;
                btn.onclick = () => checkAnswer(unit, btn);
                grid.appendChild(btn);
            });
        }

        function checkAnswer(selectedUnit, clickedBtn) {
            const correctAnswer = currentQuestions[currentIndex].unit;
            const feedback = document.getElementById('feedback');
            const buttons = document.querySelectorAll('#options-grid button');
            
            buttons.forEach(btn => btn.disabled = true);

            if (selectedUnit === correctAnswer) {
                score += 4;
                updateScore();
                feedback.innerText = "âœ¨ å¤ªå²å®³äº†ï¼ç­”å°äº†";
                feedback.className = "mt-6 text-center h-8 font-bold text-lg text-green-500 correct-pop";
                clickedBtn.classList.replace('border-blue-200', 'border-green-400');
                clickedBtn.classList.add('bg-green-50');
            } else {
                feedback.innerText = `ğŸ’¡ å“å‘€ï¼Œé€™é¡Œæ‡‰è©²æ˜¯ã€Œ${correctAnswer}ã€`;
                feedback.className = "mt-6 text-center h-8 font-bold text-lg text-red-500";
                clickedBtn.classList.replace('border-blue-200', 'border-red-400');
                clickedBtn.classList.add('bg-red-50');
                
                // æ¨™è¨˜æ­£ç¢ºç­”æ¡ˆ
                buttons.forEach(btn => {
                    if (btn.innerText === correctAnswer) {
                        btn.classList.replace('border-blue-200', 'border-green-400');
                    }
                });
            }

            setTimeout(() => {
                currentIndex++;
                if (currentIndex < currentQuestions.length) {
                    showQuestion();
                } else {
                    endGame();
                }
            }, 1500);
        }

        function updateScore() {
            document.getElementById('score').innerText = score;
        }

        function endGame() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            getAiFinalSummary();
        }
    </script>
</body>
</html>
